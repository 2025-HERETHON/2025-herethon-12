<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'chat/common.css' %}" />
    <link rel="stylesheet" href="{% static 'chat/chat.css' %}" />
    <script defer src="{% static 'chat/js/chat.js' %}"></script>
    <title>Dearbebe</title>
  </head>
  <body>
    <script>
      const isCompleted = {{ is_completed|yesno:"true,false" }};
    </script>
    <!-- ê±°ë˜ ì™„ë£Œ ëª¨ë‹¬ -->
    {% block content %}
    <div class="complete-modal hidden">
      <p>ê±°ë˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ì–´ìš”?</p>
      <div class="x-divide"></div>
      <div class="complete-modal-bottom">
        <button type="button" id="cancel">ì•„ë‹ˆì˜¤</button>
        <div class="y-divide"></div>
        <button type="button" id="ok">ë„¤</button>
      </div>
    </div>

    <div class="success-modal hidden">
      <form method="POST" action="{% url 'chat:complete_trade' thread.thread_id %}" id="complete-form">
        {% csrf_token %}
        <p>ğŸ‰ê±°ë˜ê°€ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        <button type="submit" id="check">í™•ì¸</button>
      </form>
    </div>

    <div class="darken hidden"></div>

    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="img-preview hidden">
      <img src="" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€">
    </div>
    <div class="preview-darken hidden"></div>

    <div class="header">
      <a href="{{ request.session.previous_page|default:redirect_url }}" class="back-btn">
        <img src="{% static 'chat/images/back.svg' %}" alt="ë’¤ë¡œê°€ê¸°" />
      </a>
      <div class="header-title">ìª½ì§€</div>
      <a href="" class="refresh-btn">
        <img src="{% static 'chat/images/refresh-btn.svg' %}" alt="ìƒˆë¡œê³ ì¹¨">
      </a>
    </div>

    <div class="main-container">
      <!-- ê±°ë˜ ì™„ë£Œ ìƒíƒœ í™•ì¸ì„ ìœ„í•´ ì„ì˜ë¡œ ì§‘ì–´ë„£ì—ˆìŠµë‹ˆë‹¤ -->
       <div id="is-completed" data-completed="{{ is_completed }}"></div>
    <div class="complete-bar">
      {% if is_receiver %}
        {% if is_completed %}
          <div class="complete-desc">ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
          <button class="complete-btn" disabled>ê±°ë˜ ì™„ë£Œ</button>
        {% else %}
          <div class="complete-desc">ê±°ë˜ê°€ ëë‚˜ì…¨ë‹¤ë©´ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì™„ë£Œí•´ ì£¼ì„¸ìš”.</div>
          <button id="complete-btn">ê±°ë˜ ì™„ë£Œ</button>
        {% endif %}
      {% else %}
        <!-- ì‹ ì²­ì ì…ì¥ -->
        {% if status == 'IN_PROGRESS' %}
          <div class="complete-desc">ê±°ë˜ê°€ í™•ì •ë˜ë©´ ê±°ë˜ ì™„ë£Œ ì•ˆë‚´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <button class="complete-btn">ê±°ë˜ì¤‘</button>
        {% elif status == 'COMPLETED' %}
          <div class="complete-desc">ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
          <button class="complete-btn" disabled>ê±°ë˜ ì™„ë£Œ</button>
        {% endif %}
      {% endif %}
    </div>

      <div class="chatting">
        {% for date, messages in grouped_messages.items %}
        <div class="chat-container">
          <div class="date">{{ date }}</div>

            {% for msg in messages %}
              {% if msg.member == request.user %}
          <div class="my-chats">
            <div class="my-msg">
              {% if msg.image %}
              <div class="my-msg-content-photo">
                        <img src="{{ msg.image.url }}" alt="ì‚¬ì§„">
              </div>
              {% elif msg.content %}
              <div class="my-msg-content">{{ msg.content }}</div>
              {% endif %}
              <div class="my-msg-time">{{ msg.sent_at|time:"H:i" }}</div>
            </div>
          </div>
          {% else %}
          <div class="your-chats">
            <div class="your-profile-img">
              {% if msg.member.image %}
                    <img src="{{ msg.member.image.url }}" alt="ìƒëŒ€ í”„ë¡œí•„ ì‚¬ì§„">
              {% else %}
                    <img src="{% static 'chat/images/default_profile.png' %}" alt="ìƒëŒ€ í”„ë¡œí•„ ì‚¬ì§„">
              {% endif %}
            </div>
            <div class="your-msgs">
              <div class="your-nickname">{{ msg.member.nickname }}</div>
              <div class="your-msg">
                {% if msg.image %}
                <div class="your-msg-content-photo">
                          <img src="{{ msg.image.url }}" alt="ì‚¬ì§„">
                </div>
                {% elif msg.content %}
                <div class="your-msg-content">{{ msg.content }}</div>
                {% endif %}
                <div class="your-msg-time">{{ msg.sent_at|time:"H:i" }}</div>
              </div>
            </div>
          </div>
              {% endif %}
            {% endfor %}
          <div id="scroll-anchor"></div>
        </div>
        {% endfor %}
      </div>
      <div class="chat-input-wrapper">
        <form method="POST" enctype="multipart/form-data" action="{% url 'chat:send_message' thread.thread_id %}" class="chat-input">
          {% csrf_token %}
          <label for="img-input" id="img-input-label">
            <input type="file" name="image" accept="image/*" id="img-input">
            <img src="{% static 'chat/images/camera.svg' %}" alt="ì‚¬ì§„ ë“±ë¡ ì•„ì´ì½˜">
          </label>
          <input type="text" name="content" id="text-input">
          <label for="send-btn" id="send-btn-label">
            <input type="submit" id="send-btn">
            <img src="{% static 'chat/images/send.svg' %}" alt="ë©”ì„¸ì§€ ì „ì†¡ ì•„ì´ì½˜">
          </label>
        </form>
      </div>
    </div>
    {% endblock %}
  </body>
</html>
